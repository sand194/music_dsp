---
title: "R_project_main"
author: "Jakub Piasek"
date: "2024-05-27"
output: html_document
---

### unix-only function to count lines of code across all files
```{bash, engine.opts='-l'}
count_lines_of_code() {
    local directory="$1"
    local exclude_directory="$2"
    local total_lines=0

    if [ -z "$directory" ]; then
        echo "Please provide a directory."
        return 1
    fi

    if [ -z "$exclude_directory" ]; then
        echo "Please provide a directory to exclude."
        return 1
    fi

    # Find all .R and .Rmd files in the specified directory excluding the exclude_directory and count their lines
    for file in $(find "$directory" -path "$exclude_directory" -prune -o -type f \( -name "*.R" -o -name "*.Rmd" \) -print); do
        local lines=$(wc -l < "$file")
        total_lines=$((total_lines + lines))
    done

    echo "Total lines of code in .R and .Rmd files in $directory excluding $exclude_directory: $total_lines"
}

# Call the function with a specific directory and exclude directory
count_lines_of_code "." "./packrat"
```


```{r cache=FALSE, echo=FALSE, results=FALSE, warning=FALSE}
# Managing project dependencies
library(packrat)
# packrat::unbundle("packrat/bundles/music_dsp-2024-06-08.tar.gz", "packrat")


library(tidyverse)
library(lintr)
library(ggthemes)
library(ggrepel)
library(plotly)
library(fuzzyjoin)
library(flextable)
library(webshot)

# source("scraping.R", echo = F, local = knitr::knit_global())
# knitr::read_chunk('scraping.R')
```

<!--
```{r scraping.R, eval=T}

```
-->

<!--
```{r, eval = F}
knitr::read_chunk('data_export.R')
source("data_export.R", echo = F, local = knitr::knit_global())
```
-->

```{r}
source("data_import.R", echo = F, local = knitr::knit_global())
knitr::read_chunk('data_import.R')
```


Ilość rekordów we wszystkich ramkach danych

```{r}
total_rows <- ls() %>%
  set_names() %>%
  map(~ get(.)) %>%
  keep(is.data.frame) %>%
  map_int(nrow) %>%
  sum()


total_rows

total_rows > 30000
```

# Czyszczenie danych

### Usuwanie kolumny "Pos"
Aby uniknąć duplikatów w kolumnach, należy usunąć kolumnę "Pos"

```{r}
source("cleaning.R", echo = F, local = knitr::knit_global())
# knitr::read_chunk('cleaning.R') # w ostatecznym knicie zostawić tylko read_chunk
```

<!---
```{r cleaning.R, eval=T}

```
--->

# Funkcje do wizualizacji
```{r}
source("plots.R", echo = F, local = knitr::knit_global())
```

```{r}
library(magrittr)

set_flextable_defaults(
  font.size = 10, theme_fun = theme_vanilla,
  padding = 6,
  background.color = "#EFEFEF")

theme_design <- function(x) {
  x <- border_remove(x)
  std_border <- fp_border_default(width = 4, color = "white")
  x <- fontsize(x, size = 10, part = "all")
  x <- font(x, fontname = "Courier", part = "all")
  x <- align(x, align = "center", part = "all")
  x <- bold(x, bold = TRUE, part = "all")
  x <- bg(x, bg = "#475f77", part = "body")
  x <- bg(x, bg = "#eb5555", part = "header")
  x <- bg(x, bg = "#1bbbda", part = "footer")
  x <- color(x, color = "white", part = "all")
  x <- padding(x, padding = 6, part = "all")
  x <- border_outer(x, part="all", border = std_border )
  x <- border_inner_h(x, border = std_border, part="all")
  x <- border_inner_v(x, border = std_border, part="all")
  x <- set_table_properties(x, layout = "fixed")
  x
}

```


```{r}
# Data frame containing metadata about artists
OSet_artists <- import("clean_data/musicoset_metadata/artists.csv")

# OSet_artists genre variables unification
OSet_artists <- OSet_artists %>%
  mutate(main_genre = case_when(
    grepl("rap", main_genre) ~ "rap",
    grepl("hip hop", main_genre) ~ "rap",
    grepl("drill", main_genre) ~ "rap",
    grepl("rock", main_genre) ~ "rock",
    grepl("country", main_genre) ~ "country",
    grepl("r&b", main_genre) ~ "r&b",
    grepl("edm", main_genre) ~ "edm",
    grepl("pop", main_genre) ~ "pop",
    grepl("soul", main_genre) ~ "soul",
    .default = as.character(main_genre)
  ))

OSet_artists_genre <- OSet_artists %>%
  select(c("name", "main_genre"))

```



Przetwarzanie, aby uzyskać ramkę danych z najchętniej słuchanymi gatunkami i ramkę danych z najchętniej słuchanymi artystami ogólnie
```{r}
colnames(OSet_artists_genre) <- c("Artist", "Genre")

artists_genre_comparison <- ww_artisttotals%>%
  inner_join(
    spotify_listeners,
    by = "Artist",
    suffix = c(".ww", ".spotify")
  ) %>%
  inner_join(
    youtube_archive,
    by = "Artist",
    suffix = c(".ww", ".youtube")
  ) %>%
  inner_join(
    apple_songs_artisttotals,
    by = "Artist",
    suffix = c(".ww", ".apple")
  ) %>%
  inner_join(
    OSet_artists_genre,
    by = "Artist",
    suffix = c(".ww", ".genre")
  )

# Test to see if the are no duplicate rows
artists_genre_comparison %>%
  filter(Artist == "Adele")


# Column cleaning
artists_genre_comparison$Total.youtube <- str_replace_all(artists_genre_comparison$Total.youtube, ",","")
artists_genre_comparison$Total.ww <- str_replace_all(artists_genre_comparison$Total.ww, ",", "")
artists_genre_comparison$PkListeners <- str_replace_all(artists_genre_comparison$PkListeners, ",", "")
artists_genre_comparison$Total <- str_replace_all(artists_genre_comparison$Total, ",", "")
artists_genre_comparison$Listeners <- str_replace_all(artists_genre_comparison$Listeners , ",", "")


artists_genre_comparison <- artists_genre_comparison %>%
  transform(
    Total.youtube = as.numeric(Total.youtube),
    Total.ww = as.numeric(Total.ww),
    PkListeners = as.numeric(PkListeners),
    Total = as.numeric(Total),
    Listeners = as.numeric(Listeners)
  ) %>%
  mutate(
    # Total.youtube column is equal to total views in millions
    Total.youtube = as.numeric(Total.youtube) * 1000000
  ) %>%
  rename(Total.apple = Total, Total.spotify = PkListeners)


# Sum of all the listeners and views across all of the dsp column
artists_genre_comparison <- artists_genre_comparison %>%
  mutate(
    Sum_listeners_views_across = Total.youtube + Total.ww + Total.apple + Total.spotify
  ) %>%
  arrange(desc(Sum_listeners_views_across))

```
```{r}
preferable_genres <- artists_genre_comparison %>%
  select(Artist, Genre, Sum_listeners_views_across) %>%
  group_by(Genre) %>%
  count() %>%
  arrange(desc(n))

head(preferable_genres)


preferable_genres_flex <- flextable(preferable_genres) %>% theme_design()

flextable(head(preferable_genres)) %>% theme_design()


```


# Wizualizacja - które gatunki są najczęściej słuchane ogólnie
```{r}
bar_plot(preferable_genres, "#581845", "Najczęciej słuchane gatunki", "plot_top_genres")

```


# Wizualizacja - najchętniej słuchani artyści na wszystkich platformach - summarized
```{r}
bubble_plots(artists_genre_comparison, Sum_listeners_views_across, "#edc491", "Najczęściej streamowani artyści", "plot_top_artists")

```




# Najchętniej słuchane gatunki na spotify - worldwide
```{r}
preferable_genres_spotify <- suppressWarnings({
  spotify_artists %>%
    mutate(across(c('Streams', 'Daily', 'As lead', 'Solo', 'As feature'), ~ str_replace(., ",", ""))) %>%
    mutate(across(c('Streams', 'Daily', 'As lead', 'Solo', 'As feature'), ~ as.numeric(.) * 1000000)) %>%
    left_join(
      OSet_artists_genre,
      by = "Artist",
      suffix = c(".spotify", ".oset")
    ) %>%
    drop_na() %>% # dropping rows that were not matched in left_join
    select(
      Artist, Genre, Streams
    ) %>%
    group_by(Genre) %>%
    count() %>%
    arrange(desc(n))
})


head(preferable_genres_spotify)


preferable_genres_spotify_flex <- flextable(preferable_genres_spotify) %>% add_header_lines("Spotify") %>% theme_design()

flextable(head(preferable_genres_spotify)) %>% add_header_lines("Spotify") %>% theme_design()


```


```{r}
bar_plot(preferable_genres_spotify, "#6cd980", "Najczęściej słuchane gatunki na Spotify", "plot_top_genres_spotify")

```


# Wizualizacja - najchętniej słuchani artyści na spotify - worldwide - summarized
```{r}
# TODO pogrupowac ramki wedlug liczb z poszczegolnych serwisow
bubble_plots(artists_genre_comparison, Total.spotify, "#6cd980", "Najczęściej streamowani artyści na Spotify", "plot_top_artists_spotify")

```

# TODO Wizualizacja - najchętniej słuchani artyści na spotify - w polsce - summarized





# Najczęściej słuchane gatunki - Apple Music - worldwide
```{r}
preferable_genres_apple <- suppressWarnings({
  apple_songs_artisttotals %>%
    mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
    mutate(across(c('Total', 'Today'), ~ as.numeric(.) * 1000000)) %>%
    left_join(
      OSet_artists_genre,
      by = "Artist",
      suffix = c(".apple", ".oset")
    ) %>%
    drop_na() %>% # dropping rows that were not matched in left_join
    select(
      Artist, Genre, Total
    ) %>%
    group_by(Genre) %>%
    count() %>%
    arrange(desc(n))
})

preferable_genres_apple <- preferable_genres_apple[-6,] # removing empty row


preferable_genres_apple_flex <- flextable(preferable_genres_apple) %>% add_header_lines("Apple Music") %>% theme_design()

flextable(head(preferable_genres_apple)) %>% add_header_lines("Apple Music") %>% theme_design()

```

```{r}
bar_plot(preferable_genres_apple, "#fa2a44", "Najczęściej słuchane gatunki na Apple Music", "plot_top_genres_apple")

```


# Wizualizacja - najchętniej słuchani artyści na Apple Music - worldwide - summarized
```{r}
bubble_plots(artists_genre_comparison, Total.apple, "#e04a5d", "Najczęściej streamowani artyści na Apple Music", "plot_top_artists_apple")

```



# Najczęściej słuchane gatunki - YouTube - worldwide
```{r}
preferable_genres_yt <- suppressWarnings({
  youtube_archive %>%
    mutate(across(c('Total', '100M'), ~ str_replace(., ",", ""))) %>%
    mutate(across(c('Total', '100M'), ~ as.numeric(.) * 1000000)) %>%
    left_join(
      OSet_artists_genre,
      by = "Artist",
      suffix = c(".youtube", ".oset")
    ) %>%
    drop_na() %>% # dropping rows that were not matched in left_join
    select(
      Artist, Genre, Total
    ) %>%
    group_by(Genre) %>%
    count() %>%
    arrange(desc(n))
})


preferable_genres_yt_flex <- flextable(preferable_genres_yt) %>% add_header_lines("YouTube") %>% theme_design()

flextable(head(preferable_genres_yt)) %>% add_header_lines("YouTube") %>% theme_design()

```

```{r}
bar_plot(preferable_genres_yt, "#db0000", "Najczęściej słuchane gatunki na YouTube", "plot_top_genres_yt")

```

# Wizualizacja - najchętniej słuchani artyści na YouTube - worldwide - summarized
```{r}
bubble_plots(artists_genre_comparison, Total.youtube, "#deb3b1", "Najczęściej streamowani artyści na YouTube", "plot_top_artists_yt")

```



# Najczęściej słuchane gatunki - iTunes - worldwide
```{r}
preferable_genres_itunes <- suppressWarnings({
  ww_artisttotals %>%
    mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
    mutate(across(c('Total', 'Today'), ~ as.numeric(.) * 1000000)) %>%
    left_join(
      OSet_artists_genre,
      by = "Artist",
      suffix = c(".ww", ".oset")
    ) %>%
    drop_na() %>% # dropping rows that were not matched in left_join
    select(
      Artist, Genre, Total
    ) %>%
    group_by(Genre) %>%
    count() %>%
    arrange(desc(n))
})

preferable_genres_itunes <- preferable_genres_itunes[-5,] # removing empty genre row

preferable_genres_itunes_flex <- flextable(preferable_genres_itunes) %>% add_header_lines("iTunes") %>% theme_design()

flextable(head(preferable_genres_itunes)) %>% add_header_lines("iTunes") %>% theme_design()

```

# Wizualizacja - najchętniej słuchani artyści na iTunes - worldwide - summarized
```{r}
bar_plot(preferable_genres_itunes, "#649fe8", "Najczęściej słuchane gatunki na iTunes", "plot_top_genres_itunes")

```

```{r}
bubble_plots(artists_genre_comparison, Total.ww, "#649fe8", "Najczęściej streamowani artyści na iTunes", "plot_top_artists_itunes")

```




# TODO ZROBIĆ JESZCZE DLA PIOSENEK OSOBNE WIZUALIZACJE (dla wszystkich 4 platform) I PORÓWNANIA
```{r, warning=FALSE}
# Top songs df cleaning
ww_totals <- ww_totals %>%
  mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
  mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
  mutate(
    Total = as.numeric(Total),
    Today = as.numeric(Today)
  ) %>%
  select(`Artist and Title`, Total) %>%
  arrange(desc(Total))

apple_songs_totals <- apple_songs_totals %>%
  mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
  mutate(across(c('Total', 'Today'), ~ str_replace(., ",", ""))) %>%
  mutate(
    Total = as.numeric(Total),
    Today = as.numeric(Today)
  ) %>%
  select(`Artist and Title`, Total) %>%
  arrange(desc(Total))

spotify_most_streamed_songs <- spotify_most_streamed_songs %>%
  mutate_all(~ gsub('"', '', .)) %>%
  rename(Total = 'Streams(billions)') %>%
  mutate(Total = as.numeric(Total) * 1000000000) %>%
  drop_na() %>% # dropping rows that were not matched
  mutate('Artist and Title' = paste(`Artist(s)`, Song, sep = " - ")) %>%
  select(`Artist and Title`, Total) %>%
  arrange(desc(Total))

# Vector of substrings to remove
substrings_to_remove <- c("Official.*", "M/V", "MV", "Video")
# Create a regex pattern from the vector of substrings
pattern <- str_c(substrings_to_remove, collapse = "|")

youtube_topvideos <- youtube_topvideos %>%
  mutate(across(c("Views", "Yesterday"), ~ gsub('\\,', '', .))) %>%
  mutate(across(c('Views', 'Yesterday'), ~ str_replace(., ",", ""))) %>%
  mutate(across(c('Views'), ~ str_replace(., ',', ""))) %>%
  mutate(
    Views = as.numeric(Views),
    Yesterday = as.numeric(Yesterday)
  ) %>%
  rename('Artist and Title' = Video) %>%
  rename(Total = Views) %>%
  mutate(`Artist and Title` = str_replace(`Artist and Title`, "\\(.*\\)", "")) %>%
  mutate(`Artist and Title` = str_replace(`Artist and Title`, "\\[.*\\]", "")) %>%
  mutate(`Artist and Title` = str_remove_all(`Artist and Title`, pattern)) %>%
  select(`Artist and Title`, Total) %>%
  arrange(desc(Total))

```


```{r}
ww_totals_flex <- flextable(ww_totals) %>% add_header_lines("iTunes") %>% theme_design()
apple_songs_totals_flex <- flextable(apple_songs_totals) %>% add_header_lines("Apple Music") %>% theme_design()
spotify_most_streamed_songs_flex <- flextable(spotify_most_streamed_songs) %>% add_header_lines("Spotify") %>% theme_design()
youtube_topvideos_flex <- flextable(youtube_topvideos) %>% add_header_lines("YouTube") %>% theme_design()


ww_totals_flex
apple_songs_totals_flex
spotify_most_streamed_songs_flex
youtube_topvideos_flex
```



# Ile jest podobnych a ile różnych
```{r, warning=FALSE,message=FALSE,error=FALSE, results='hide'}
top_songs_total <- bind_rows(spotify_most_streamed_songs %>% top_n(50), ww_totals %>% top_n(50), apple_songs_totals %>% top_n(50), youtube_topvideos %>% top_n(50))

top_songs_total_scatter <- top_songs_total %>%
  group_by(`Artist and Title`) %>%
  mutate(is_duplicate = n() > 1) %>%
  ungroup()

count_data <- top_songs_total_scatter %>%
  summarise(count_true = sum(is_duplicate),
            count_false = sum(!is_duplicate))

top_songs_total_bar <- data.frame(
  Duplicate = c("Same", "Different"),
  Count = c(count_data$count_true, count_data$count_false)
)


top_songs_differences_bar_plot <- top_songs_total_bar %>% ggplot(
  aes(
    x = Duplicate,
    y = Count,
    fill = Duplicate
    )
  ) + geom_bar(
    stat = "identity",
    width = 0.5,
    ) + labs(
      title = "Różnice w top 100 piosenek z każdego serwisu",
    ) + xlab(
      ""
      ) + ylab(
        ""
      ) + theme_fivethirtyeight() + scale_fill_fivethirtyeight() + theme(
        plot.title = element_text(size = 13),
        plot.subtitle = element_text(size = 10),
        legend.position = "none"
     ) + 
    scale_fill_manual(values = c("Same" = "#d13e2e", "Different" = "#2e85d1"))


top_songs_differences_scatter_plot <- top_songs_total_scatter %>% ggplot(aes(x = `Artist and Title`, y = Total, color = is_duplicate)) +
  geom_point(size = 3) +
  labs(
      title = "Różnice w top 100 piosenek z każdego serwisu"
    ) + xlab(
      "Ilość streamów"
      ) + ylab(
        ""
      ) + theme_fivethirtyeight() + scale_fill_fivethirtyeight() + theme(
        plot.title = element_text(size = 13),
        plot.subtitle = element_text(size = 10),
        legend.position = "none",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        panel.grid.minor = element_line(color = "grey95", linewidth = 0.25)
     ) + 
  scale_color_manual(values = c("TRUE" = "#d13e2e", "FALSE" = "#2e85d1"))



top_songs_differences_bar_plot
top_songs_differences_scatter_plot
```
